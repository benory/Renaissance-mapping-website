<script>

// Function to initialize all decades between a given start and end year
function initializeDecades(startYear, endYear) {
    const histogram = {};
    for (let year = startYear; year <= endYear; year += 10) {
        histogram[year] = {
            total: 0,
            BCO: 0,
            BMU: 0,
            BNO: 0,
            highlights: {} // name → count
        };
    }
    return histogram;
}

// Function to get all decades between two years
function getDecades(earliestYear, latestYear) {
    const decades = [];
    let startDecade = getDecade(earliestYear);
    const endDecade = getDecade(latestYear);

    for (let decade = startDecade; decade <= endDecade; decade += 10) {
        decades.push(decade);
    }
    return decades;
}

// Function to calculate the decade from a given year
function getDecade(year) {
    return Math.floor(year / 10) * 10;
}

function withOpacity(color, alpha = 0.65) {
    if (!color) return null;

    // rgb() → rgba()
    if (color.startsWith("rgb(")) {
        return color.replace("rgb(", "rgba(").replace(")", `, ${alpha})`);
    }

    // hex → rgba()
    if (color.startsWith("#")) {
        const bigint = parseInt(color.slice(1), 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    return color;
}

// Function to update the histogram DOM
function updateHistogram(histogramCounts) {
    const histogramRow = document.getElementById("histogramRow");
    histogramRow.innerHTML = '';

    const decades = Object.keys(histogramCounts).sort((a, b) => a - b);

    const maxTotal = Math.max(
        ...decades.map(d => histogramCounts[d].total)
    );

    const maxHeight = 50;

    // --- Left label cell ---
    const labelCell = document.createElement("td");
    labelCell.style.verticalAlign = "top";
    labelCell.style.width = "50px";

    const maxLabel = document.createElement("div");
    maxLabel.textContent = maxTotal;
    maxLabel.style.fontSize = "12px";
    maxLabel.style.position = "relative";
    maxLabel.style.left = "-25px";
    maxLabel.style.top = "-10px";

    labelCell.appendChild(maxLabel);
    histogramRow.appendChild(labelCell);

    // --- Histogram bars ---
    decades.forEach(decade => {
        const bin = histogramCounts[decade];
        const cell = document.createElement("td");

        const bar = document.createElement("div");
        bar.style.display = "flex";
        bar.style.flexDirection = "column-reverse";
        bar.style.alignItems = "stretch";
        bar.style.height = maxHeight + "px";
        bar.style.width = "100%";

        const hasHighlights = Object.keys(bin.highlights).length > 0;

        if (hasHighlights) {
            // STACK BY SELECTED PERSON
            Object.entries(bin.highlights).forEach(([name, count]) => {
                const color = getHighlightColorForPerson(name);
                if (!color) return;

                const seg = document.createElement("div");
                seg.style.backgroundColor = withOpacity(color, 0.65);
                seg.style.height = (count / maxTotal) * maxHeight + "px";
                seg.style.borderTop = "1px solid rgba(0,0,0,0.15)";
                bar.appendChild(seg);
            });
        } else {
            // STACK BY CATEGORY
            const stacks = [
                { count: bin.BCO, color: "#440154" }, // composers
                { count: bin.BMU, color: "#23ed5c" }, // musicians
                { count: bin.BNO, color: "#fde725" }  // non-musicians
            ];

            stacks.forEach(({ count, color }) => {
                if (!count) return;

                const seg = document.createElement("div");
                seg.style.backgroundColor = withOpacity(color, 0.65);
                seg.style.height = (count / maxTotal) * maxHeight + "px";
                seg.style.borderTop = "1px solid rgba(0,0,0,0.15)";
                bar.appendChild(seg);
            });
        }

        bar.title = `${bin.total} events in the ${decade}s`;
        cell.appendChild(bar);
        histogramRow.appendChild(cell);
    });
}

// Sidebar coloring helper (unchanged logic, included for completeness)
function getSidebarColor(personID, personName) {
    const type = personID.substring(0, 3);

    const activeNames = new Set([
        ...getActiveNamesFromContainer('composer-active'),
        ...getActiveNamesFromContainer('musician-active'),
        ...getActiveNamesFromContainer('non-musician-active')
    ]);

    if (activeNames.has(personName)) {
        return getHighlightColorForPerson(personName);
    }

    if (type === "BCO") return "#440154";
    if (type === "BMU") return "#23ed5c";
    if (type === "BNO") return "#fde725";

    return "#999";
}

// Deterministic highlight color assignment
function getHighlightColorForPerson(name) {
    if (!name) return null;

    if (!getHighlightColorForPerson.cache) {
        getHighlightColorForPerson.cache = new Map();
        getHighlightColorForPerson.index = 0;
    }

    const key = name.toLowerCase();
    if (getHighlightColorForPerson.cache.has(key)) {
        return getHighlightColorForPerson.cache.get(key);
    }

    const color = highlightPalette[
        getHighlightColorForPerson.index % highlightPalette.length
    ];

    getHighlightColorForPerson.cache.set(key, color);
    getHighlightColorForPerson.index++;
    return color;
}

</script>