<script>

let MAP = {};
MAP.results = {};            // elements for displaying search results by sheet name
MAP.menus = {};              // elements for displaying search menus by sheet name
MAP.activeResults = null;
MAP.lookup = {};

MAP.index = {};						// header name mapping by sheet
MAP.index.Archival_Docs = {};		// header names for archival documents sheet
MAP.index.Bibliography = {};		// header names for bibliography sheet
MAP.index.Bio_Composers = {};		// header names for biography sheet for composers
MAP.index.Bio_Musicians = {};		// header names for biography sheet for musicians
MAP.index.Bio_Nonmusicians = {};	// header names for biography sheet for non-musicians
MAP.index.Doc_Entries = {};			// header names for document entries sheet
MAP.index.Events = {};				// header names for events sheet
MAP.index.Headers = {};				// header names for headers sheet
MAP.index.Institutions = {};		// header names for institutions sheet
MAP.index.Locations = {};			// header names for locations sheet
MAP.index.Occasions = {};			// header names for occasions sheet

MAP.METADATA = {};
MAP.METADATA.Archival_Docs = {% include metadata/Archival_Docs.json %};
MAP.METADATA.Bibliography = {% include metadata/Bibliography.json %};
MAP.METADATA.Bio_Composers = {% include metadata/Bio_Composers.json %};
MAP.METADATA.Bio_Musicians = {% include metadata/Bio_Musicians.json %};
MAP.METADATA.Bio_Nonmusicians = {% include metadata/Bio_Nonmusicians.json %};
MAP.METADATA.Doc_Entries = {% include metadata/Doc_Entries.json %};
MAP.METADATA.Events = {% include metadata/Events.json %};
MAP.METADATA.Headers = {% include metadata/Headers.json %};
MAP.METADATA.Institutions = {% include metadata/Institutions.json %};
MAP.METADATA.Locations = {% include metadata/Locations.json %};
MAP.METADATA.Occasions = {% include metadata/Occasions.json %};


// Create map for targets
const targets = {% include metadata/Targets.json %};

const targetTypeByNormalizedName = new Map();

targets.forEach(t => {
  const full =
    t.First
      ? `${t.First} ${t.Last}`
      : t.Last;

  targetTypeByNormalizedName.set(
    normalizeName(full),
    t["Target Type"]
  );
});

// Global variables for certainty
let locationCertainty = "";
let earliestDateCertainty = "";
let latestDateCertainty = "";
let rangeCertainty = "";

// Global variables for chronological slider
let minDate = new Date("1400-01-01");
let maxDate = new Date("1600-01-01");
let currentDateRange = [minDate, maxDate];

// Global variables for markerCluster
let markerCluster;

// Global variable for select institutions
let institutionFilter;

// Colors for when multiple figures are selected
const highlightPalette = [
    "#440154", // purple
    "#ff7f00", // orange
    "#5ec962", // green
    "#fde725", // yellow
    "#d62728", // red
    "#21918c", // teal
    "#3b528b", // blue-purple
    "#9467bd"  // violet
];

// Sidebar groupings
let sidebarGroups = new Map(); // personprocessed â†’ { headerRow, body }
let useBuckets = true;

let events = {% include metadata/Events.json %};

const clusterCache = new Map();

function normalizeName(str) {
  return str
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // strip accents
    .replace(/[^a-z\s]/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

function sanitizeEventId(eventid) {
    return eventid.replace(/[^a-zA-Z0-9-_]/g, '_'); // Replace invalid characters with underscores
}

function normalizeName(str) {
  return str
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // strip accents
    .replace(/[^a-z\s]/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

</script>