<script>

function updateSidebar() {
    sidebarGroups.clear();

    document.getElementById('sidebar-composers').innerHTML = '';
    document.getElementById('sidebar-musicians').innerHTML = '';
    document.getElementById('sidebar-nonmusicians').innerHTML = '';

    const checkboxStates = getCheckboxStates();
    const minYear = parseInt(document.getElementById('date-slider-min').value, 10);
    const maxYear = parseInt(document.getElementById('date-slider-max').value, 10);

    const activeNames = new Set([
        ...getActiveNamesFromContainer('composer-active'),
        ...getActiveNamesFromContainer('musician-active'),
        ...getActiveNamesFromContainer('non-musician-active')
    ]);

    const searchInput = document.querySelector("#input");
    const searchRegex = searchInput && searchInput.value.trim() !== ""
        ? new RegExp(searchInput.value, 'i')
        : null;

    const visibleMarkers = getVisibleMarkers().filter(({ personID, locationCertainty, alias,
        earliestDateCertainty, latestDateCertainty, rangeCertainty,
        earliestyear, latestyear, text, personprocessed, locationprocessed, institution }) => {

        const type = personID.substring(0, 3);
        const certainties = { locationCertainty, earliestDateCertainty, latestDateCertainty, rangeCertainty };

        let show = shouldShowMarker(type, checkboxStates, certainties, institution);

        if (show && activeNames.size > 0 && !activeNames.has(personprocessed)) show = false;

        if (show && searchRegex && !(text.match(searchRegex) ||
            locationprocessed.match(searchRegex) ||
            alias.join(" ").match(searchRegex) ||
            String(earliestyear).match(searchRegex) ||
            String(latestyear).match(searchRegex))) {
            show = false;
        }

        if (show && (earliestyear > maxYear || latestyear < minYear)) show = false;

        return show;
    });

    const uniquePeople = new Set(
        visibleMarkers.map(m => m.personprocessed)
    );

    useBuckets = uniquePeople.size > 1;

    // Chronological sort (earliest → latest)
    visibleMarkers.sort((a, b) => {
        const ay = Number(a.earliestyear) || 0;
        const by = Number(b.earliestyear) || 0;
        if (ay !== by) return ay - by;

        const am = Number(a.earliestmonth) || 0;
        const bm = Number(b.earliestmonth) || 0;
        if (am !== bm) return am - bm;

        const ad = Number(a.earliestday) || 0;
        const bd = Number(b.earliestday) || 0;
        return ad - bd;
    });

    // Populate sidebar
    visibleMarkers.forEach(markerData => {
        updateMarkerSidebar(markerData, true, markerData.eventid);
    });
}

function getHighlightColorForPerson(name) {
    const allSelected = Array.from(selectedNames);
    const index = allSelected.indexOf(name);

    if (index === -1) return null; // no highlight color

    return getColorForIndex(index);
}

function updateMarkerSidebar(markerData, show, eventid) {
    if (!show) return;

    const { personID, personprocessed } = markerData;
    const type = personID.substring(0, 3);

    const container =
        type === "BCO" ? document.getElementById("sidebar-composers") :
        type === "BMU" ? document.getElementById("sidebar-musicians") :
                         document.getElementById("sidebar-nonmusicians");

    // If only one person, skip buckets entirely
    if (!useBuckets) {
        updateMarkerSidebarRow(markerData, container, eventid);
        return;
    }

    // Otherwise: grouped (current behavior)
    if (!sidebarGroups.has(personprocessed)) {
        const headerRow = document.createElement("tr");
        const headerCell = document.createElement("td");
        headerCell.className = "sidebar-person";

        // Match bucket color to marker color
        const highlightColor = getSidebarHighlightColor(personprocessed);

        let bgColor;
        let borderColor;

        if (highlightColor) {
            bgColor = highlightColor + "22";   // light tint
            borderColor = highlightColor;
        } else {
            if (type === "BCO") bgColor = "rgba(68, 1, 84, 0.12)";
            else if (type === "BMU") bgColor = "rgba(35, 237, 92, 0.12)";
            else bgColor = "rgba(253, 231, 37, 0.18)";
            borderColor = "transparent";
        }

        headerCell.style.backgroundColor = bgColor;
        headerCell.style.borderLeft = `4px solid ${borderColor}`;

        const caret = document.createElement("span");
        caret.className = "sidebar-caret";
        caret.textContent = "▸";

        headerCell.appendChild(caret);
        const nameSpan = document.createElement("span");
        nameSpan.textContent = ` ${personprocessed}`;

        const countSpan = document.createElement("span");
        countSpan.className = "sidebar-count";
        countSpan.textContent = " (0 events)";

        headerCell.appendChild(nameSpan);
        headerCell.appendChild(countSpan);
        headerRow.appendChild(headerCell);
        container.appendChild(headerRow);

        const body = document.createElement("tbody");
        body.className = "sidebar-events";
        container.appendChild(body);

        headerCell.addEventListener("click", () => {
            caret.classList.toggle("open");
            body.classList.toggle("open");
        });

        sidebarGroups.set(personprocessed, {
            body,
            countSpan
        });
    }

    const groupBody = sidebarGroups.get(personprocessed).body;

    updateMarkerSidebarRow(markerData, groupBody, eventid);
}

function updateMarkerSidebarRow(
    { text, personID, personprocessed, locationprocessed, daterange, description },
    tableBody,
    eventid
) {
    const sanitizedEventId = sanitizeEventId(eventid);
    if (tableBody.querySelector(`#marker-${sanitizedEventId}`)) return;

    const row = document.createElement('tr');
    row.id = `marker-${sanitizedEventId}`;

    const highlightColor = getSidebarHighlightColor(personprocessed);

    let backgroundColor;
    if (highlightColor) {
        backgroundColor = highlightColor + "22";
    } else {
        const type = personID.substring(0, 3);
        if (type === "BCO") backgroundColor = "rgba(68, 1, 84, 0.1)";
        else if (type === "BMU") backgroundColor = "rgba(35, 237, 92, 0.1)";
        else backgroundColor = "rgba(253, 231, 37, 0.1)";
    }

    row.style.backgroundColor = backgroundColor;
    row.style.padding = '8px';
    row.style.borderBottom = '1px solid #ddd';

    const cell = document.createElement('td');
    const truncatedDescription = description
        ? description.slice(0, 100) + (description.length > 100 ? '...' : '')
        : '';

    cell.innerHTML = `
        <b>${personprocessed}</b>, ${locationprocessed || ''}, ${daterange || ''}${truncatedDescription ? ': ' + truncatedDescription : ''}
    `.trim();

    row.appendChild(cell);

    row.addEventListener('click', () => {
        const marker = markers.find(m => m.eventid === eventid)?.marker;
        if (!marker) return;
        const targetZoom = Math.min(map.getZoom() + 1, 8);
        map.setView(marker.getLatLng(), targetZoom, { animate: true });
        marker.openPopup();
    });

    tableBody.appendChild(row);

    // Update event count in the header
    const group = sidebarGroups.get(personprocessed);
    if (group && group.countSpan) {
        const current = parseInt(group.countSpan.dataset.count || "0", 10) + 1;
        group.countSpan.dataset.count = current;
        group.countSpan.textContent = ` (${current} event${current === 1 ? "" : "s"})`;
    }
}

// Update Sidebar with Cluster Points
function updateSidebarWithClusterMarkers(clusterMarkers) {
    // Clear existing sidebar entries
    document.getElementById('sidebar-composers').innerHTML = '';
    document.getElementById('sidebar-musicians').innerHTML = '';
    document.getElementById('sidebar-nonmusicians').innerHTML = '';

    clusterMarkers.forEach(marker => {
        // Find the corresponding data entry
        const markerData = markers.find(m => m.marker === marker);

        if (markerData) {
            updateMarkerSidebar({
                text: markerData.text,
                personID: markerData.personID,
                personprocessed: markerData.personprocessed,
                locationprocessed: markerData.locationprocessed,
                daterange: markerData.daterange,
                description: markerData.description
            }, true, markerData.eventid);
        }
    });
}

function getSidebarHighlightColor(personName) {
    const activeNames = new Set([
        ...getActiveNamesFromContainer('composer-active'),
        ...getActiveNamesFromContainer('musician-active'),
        ...getActiveNamesFromContainer('non-musician-active')
    ]);

    if (!activeNames.has(personName)) return null;
    return getHighlightColorForPerson(personName);
}

</script>